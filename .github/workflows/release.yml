name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          path-type: inherit
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-sqlcipher

      - name: Build
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          export CGO_ENABLED=1
          export CC=gcc
          go build -trimpath -buildvcs=false -o sshthing.exe ./cmd/sshthing

      - name: Smoke test binary
        shell: msys2 {0}
        run: |
          ./sshthing.exe --version
          ./sshthing.exe --help >/dev/null

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress

      - name: Build installer
        shell: pwsh
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          $versionLabel = $env:GITHUB_REF_NAME
          if ($versionLabel.StartsWith('v')) { $versionLabel = $versionLabel.Substring(1) }
          $coreMatch = [regex]::Match($versionLabel, '^\d+\.\d+\.\d+')
          if (-not $coreMatch.Success) { throw "Tag does not contain semantic core version: $versionLabel" }
          $versionCore = $coreMatch.Value
          $versionInfo = "$versionCore.0"
          $candidates = @(
            "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe",
            "$env:ProgramFiles\Inno Setup 6\ISCC.exe"
          )
          $iscc = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $iscc) { throw "ISCC.exe not found after install" }
          & $iscc "installer\sshthing.iss" "/DMyAppVersion=$versionCore" "/DMyAppVersionInfoVersion=$versionInfo"

      - name: Smoke test installer install/uninstall
        shell: pwsh
        run: |
          $installDir = Join-Path $env:RUNNER_TEMP "sshthing-install"
          $installLog = Join-Path $env:RUNNER_TEMP "sshthing-install.log"
          $uninstallLog = Join-Path $env:RUNNER_TEMP "sshthing-uninstall.log"
          if (Test-Path $installDir) { Remove-Item -Recurse -Force $installDir }
          New-Item -ItemType Directory -Path $installDir | Out-Null

          $setup = Join-Path $PWD "sshthing-setup-windows-amd64.exe"
          if (-not (Test-Path $setup)) { throw "Installer not found: $setup" }

          $installProc = Start-Process -FilePath $setup -ArgumentList @('/VERYSILENT', '/SUPPRESSMSGBOXES', '/NORESTART', '/SP-', "/DIR=$installDir", "/LOG=$installLog") -Wait -PassThru
          if ($installProc.ExitCode -ne 0) { throw "Installer exited with code $($installProc.ExitCode)" }

          $installedExe = Join-Path $installDir "sshthing.exe"
          if (-not (Test-Path $installedExe)) { throw "Installed exe not found: $installedExe" }
          & $installedExe --version
          if ($LASTEXITCODE -ne 0) { throw "Installed binary exited with code $LASTEXITCODE" }

          $uninstaller = Join-Path $installDir "unins000.exe"
          if (-not (Test-Path $uninstaller)) { throw "Uninstaller not found: $uninstaller" }
          $uninstallProc = Start-Process -FilePath $uninstaller -ArgumentList @('/VERYSILENT', '/SUPPRESSMSGBOXES', '/NORESTART', "/LOG=$uninstallLog") -Wait -PassThru
          if ($uninstallProc.ExitCode -ne 0) { throw "Uninstaller exited with code $($uninstallProc.ExitCode)" }

          if (Test-Path $installedExe) { throw "Uninstall did not remove executable: $installedExe" }

      - name: Create archive
        shell: pwsh
        run: |
          Compress-Archive -Path sshthing.exe, README.md, LICENSE -DestinationPath sshthing-windows-amd64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sshthing-windows-amd64
          path: |
            sshthing-windows-amd64.zip
            sshthing-setup-windows-amd64.exe

  build-macos:
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install SQLCipher
        run: brew install sqlcipher

      - name: Build
        run: |
          export CGO_ENABLED=1
          export GOARCH=amd64
          export CGO_CFLAGS="-I$(brew --prefix sqlcipher)/include"
          export CGO_LDFLAGS="-L$(brew --prefix sqlcipher)/lib"
          go build -trimpath -buildvcs=false -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o sshthing ./cmd/sshthing

      - name: Smoke test amd64 binary
        run: |
          ./sshthing --version
          ./sshthing --help >/dev/null
          arch_info="$(file sshthing)"
          echo "$arch_info"
          case "$arch_info" in
            *x86_64*) ;;
            *)
              echo "Expected x86_64 binary"
              exit 1
              ;;
          esac

      - name: Create archive
        run: |
          zip sshthing-macos-amd64.zip sshthing README.md LICENSE

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sshthing-macos-amd64
          path: sshthing-macos-amd64.zip

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install SQLCipher
        run: brew install sqlcipher

      - name: Build
        run: |
          export CGO_ENABLED=1
          export GOARCH=arm64
          export CGO_CFLAGS="-I$(brew --prefix sqlcipher)/include"
          export CGO_LDFLAGS="-L$(brew --prefix sqlcipher)/lib"
          go build -trimpath -buildvcs=false -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o sshthing ./cmd/sshthing

      - name: Smoke test arm64 binary
        run: |
          ./sshthing --version
          ./sshthing --help >/dev/null
          arch_info="$(file sshthing)"
          echo "$arch_info"
          case "$arch_info" in
            *arm64*) ;;
            *)
              echo "Expected arm64 binary"
              exit 1
              ;;
          esac

      - name: Create archive
        run: |
          zip sshthing-macos-arm64.zip sshthing README.md LICENSE

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sshthing-macos-arm64
          path: sshthing-macos-arm64.zip

  release:
    needs: [build-windows, build-macos, build-macos-arm64]
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets and checksums
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cp artifacts/sshthing-windows-amd64/sshthing-windows-amd64.zip dist/
          cp artifacts/sshthing-windows-amd64/sshthing-setup-windows-amd64.exe dist/
          cp artifacts/sshthing-macos-amd64/sshthing-macos-amd64.zip dist/
          cp artifacts/sshthing-macos-arm64/sshthing-macos-arm64.zip dist/
          (cd dist && sha256sum sshthing-setup-windows-amd64.exe sshthing-windows-amd64.zip sshthing-macos-amd64.zip sshthing-macos-arm64.zip > SHA256SUMS)

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            dist/sshthing-setup-windows-amd64.exe
            dist/sshthing-windows-amd64.zip
            dist/sshthing-macos-amd64.zip
            dist/sshthing-macos-arm64.zip
            dist/SHA256SUMS

      - name: Create or validate draft release
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.ref_name }}"
          repo="${{ github.repository }}"

          if gh release view "$tag" --repo "$repo" >/dev/null 2>&1; then
            is_draft="$(gh release view "$tag" --repo "$repo" --json isDraft -q .isDraft)"
            if [ "$is_draft" != "true" ]; then
              echo "Release $tag already exists and is published; refusing overwrite."
              exit 1
            fi
            echo "Reusing existing draft release: $tag"
          else
            gh release create "$tag" --repo "$repo" --draft --verify-tag --generate-notes --title "$tag"
          fi

      - name: Upload release assets to draft
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.ref_name }}"
          repo="${{ github.repository }}"
          gh release upload "$tag" \
            dist/sshthing-setup-windows-amd64.exe \
            dist/sshthing-windows-amd64.zip \
            dist/sshthing-macos-amd64.zip \
            dist/sshthing-macos-arm64.zip \
            dist/SHA256SUMS \
            --repo "$repo" \
            --clobber

      - name: Verify expected assets exist
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.ref_name }}"
          repo="${{ github.repository }}"

          declare -A seen
          while IFS= read -r asset; do
            if [ -n "$asset" ]; then
              seen["$asset"]=1
            fi
          done < <(gh release view "$tag" --repo "$repo" --json assets -q '.assets[].name')

          expected=(
            "sshthing-setup-windows-amd64.exe"
            "sshthing-windows-amd64.zip"
            "sshthing-macos-amd64.zip"
            "sshthing-macos-arm64.zip"
            "SHA256SUMS"
          )

          for asset in "${expected[@]}"; do
            if [ -z "${seen[$asset]:-}" ]; then
              echo "Missing release asset: $asset"
              exit 1
            fi
          done

      - name: Publish release
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ github.ref_name }}"
          repo="${{ github.repository }}"
          is_draft="$(gh release view "$tag" --repo "$repo" --json isDraft -q .isDraft)"
          if [ "$is_draft" = "true" ]; then
            gh release edit "$tag" --repo "$repo" --draft=false
          fi
